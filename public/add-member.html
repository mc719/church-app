<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Member</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { margin: 0; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #fff; color: #1e1e1e; }
    .page { max-width: 720px; margin: 0 auto; padding: 40px 20px 80px; }
    .bg-logo { position: fixed; top: 24px; left: 50%; transform: translateX(-50%); width: 180px; height: 180px; opacity: 0.08; background-size: contain; background-repeat: no-repeat; background-position: center; z-index: 0; pointer-events: none; display: flex; align-items: center; justify-content: center; font-size: 6rem; color: #1e3a5f; }
    h1 { margin: 0 0 24px; font-size: 2rem; color: #1e3a5f; }
    form { position: relative; z-index: 1; display: grid; gap: 16px; }
    label { font-weight: 600; margin-bottom: 6px; display: block; }
    input, select { width: 100%; padding: 12px; border: 1px solid #dcdcdc; border-radius: 8px; font-size: 1rem; }
    .actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #1e3a5f; color: white; }
    .btn-secondary { background: #e0e0e0; }
  </style>
</head>
<body>
  <div id="bgLogo" class="bg-logo"><i class="fas fa-church"></i></div>
  <div class="page">
    <h1>Add Member</h1>
    <form id="addMemberForm">
      <div>
        <label for="memberCellId">Cell Group *</label>
        <select id="memberCellId" required></select>
      </div>
      <div>
        <label for="memberTitle">Title *</label>
        <select id="memberTitle" required>
          <option value="">Select Title</option>
          <option>Brother</option>
          <option>Sister</option>
          <option>Dcns</option>
          <option>Dcn</option>
          <option>Pastor</option>
          <option>Mr</option>
          <option>Mrs</option>
          <option>Miss</option>
          <option>Master</option>
        </select>
      </div>
      <div>
        <label for="memberName">Full Name *</label>
        <input type="text" id="memberName" required>
      </div>
      <div>
        <label for="memberGender">Gender *</label>
        <select id="memberGender" required>
          <option value="">Select Gender</option>
          <option>Male</option>
          <option>Female</option>
        </select>
      </div>
      <div>
        <label for="memberMobile">Mobile *</label>
        <input type="tel" id="memberMobile" required>
      </div>
      <div>
        <label for="memberEmail">Email</label>
        <input type="email" id="memberEmail">
      </div>
      <div>
        <label for="memberRole">Cell Role *</label>
        <select id="memberRole" required>
          <option value="">Select Role</option>
          <option>Cell Leader</option>
          <option>Assistant Leader</option>
          <option>Member</option>
          <option>New Member</option>
        </select>
      </div>
      <div class="actions">
        <button type="submit" class="btn btn-primary">Add Member</button>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">Back</button>
      </div>
    </form>
  </div>
  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Please login first.');
      window.location.href = '/';
    }

    const logo = localStorage.getItem('logoImage');
    if (logo) {
      const bg = document.getElementById('bgLogo');
      bg.style.backgroundImage = `url(${logo})`;
      bg.innerHTML = '';
    }

    async function apiRequest(endpoint, options = {}) {
      const response = await fetch(endpoint, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...(options.headers || {})
        }
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || 'Request failed');
      }
      return data;
    }

    async function loadCells() {
      const cells = await apiRequest('/api/cells');
      const select = document.getElementById('memberCellId');
      select.innerHTML = '<option value="">Select Cell</option>';
      cells.forEach(cell => {
        const option = document.createElement('option');
        option.value = cell.id;
        option.textContent = cell.name;
        select.appendChild(option);
      });
    }

    document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        cellId: document.getElementById('memberCellId').value,
        title: document.getElementById('memberTitle').value,
        name: document.getElementById('memberName').value.trim(),
        gender: document.getElementById('memberGender').value,
        mobile: document.getElementById('memberMobile').value.trim(),
        email: document.getElementById('memberEmail').value.trim(),
        role: document.getElementById('memberRole').value
      };
      try {
        await apiRequest('/api/members', { method: 'POST', body: JSON.stringify(payload) });
        alert('Member added successfully!');
        e.target.reset();
      } catch (err) {
        alert('Failed to add member: ' + err.message);
      }
    });

    loadCells().catch(err => alert('Failed to load cells: ' + err.message));
  </script>
</body>
</html>
